---
- hosts: rancher_k3s_hosts
  become: true
  tasks:
    - name: Update Apt
      apt:
        autoclean: true
        autoremove: true
        clean: true
        update_cache: true
        cache_valid_time: 3600
        state: latest
        pkg:
          - emacs-nox
          - net-tools
          - htop
          - systemd-timesyncd

    - name: set timezone
      shell: timedatectl set-timezone America/Los_Angeles

    - name: Make sure timesyncd is stopped
      systemd:
        name: systemd-timesyncd.service
        state: stopped

    - name: Delete spurious timesyncd.conf file if it exists
      file:
        path: /etc/timesyncd.conf
        state: absent

    - name: Create timesyncd.conf file
      copy:
        dest: /etc/systemd/timesyncd.conf
        content: |
          [Time]
          NTP={{ ntp_server }}
          FallbackNTP={{ fallback_ntp_server }}

    - name: Make sure timesyncd is started
      systemd:
        name: systemd-timesyncd.service
        state: started

    - name: Reboot instance
      ansible.builtin.reboot:
        reboot_timeout: 600
        post_reboot_delay: 30
